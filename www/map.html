<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Smart Route Finder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Leaflet -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Routing -->
    <link rel="stylesheet"
          href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <style>
        html, body, #map {
            height: 100%;
            margin: 0;
        }

        #backBtn {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            background: white;
            font-weight: bold;
        }

        #centerBtn {
            position: absolute;
            bottom: 25px;
            right: 15px;
            z-index: 1000;
            padding: 14px;
            border-radius: 50%;
            border: none;
            background: white;
            font-size: 18px;
        }

        #searchBox {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        #searchInput {
            border: none;
            padding: 10px;
            width: 200px;
            outline: none;
        }

        #searchBtn {
            border: none;
            padding: 10px;
            background: #1e90ff;
            color: white;
            cursor: pointer;
        }
    </style>
</head>

<body>

<button id="backBtn" onclick="history.back()">‚Üê Back</button>
<button id="centerBtn">üìç</button>

<div id="searchBox">
    <input id="searchInput" type="text" placeholder="Search place..." />
    <button id="searchBtn">üîç</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<script src="cordova.js"></script>

<script>
    document.addEventListener("deviceready", () => {

        navigator.geolocation.getCurrentPosition(
            pos => {

                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const accuracy = pos.coords.accuracy;

                // MAP INIT
                const map = L.map('map').setView([lat, lng], 17);

                // SATELLITE BASE
                L.tileLayer(
                  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                  { maxZoom: 19 }
                ).addTo(map);

                // ROAD + PLACE LABELS
                L.tileLayer(
                  'https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',
                  { maxZoom: 19 }
                ).addTo(map);

                // OSM POI OVERLAY (buildings / colleges / shops)
                L.tileLayer(
                  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                  { maxZoom: 19, opacity: 0.35 }
                ).addTo(map);

                // ICONS
                const redIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [30, 50],
                    iconAnchor: [15, 50]
                });

                const blueIcon = new L.Icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
                    shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
                    iconSize: [30, 50],
                    iconAnchor: [15, 50]
                });

                // USER LOCATION
                L.marker([lat, lng], { icon: redIcon })
                    .addTo(map)
                    .bindPopup("üî¥ Your Location")
                    .openPopup();

                // ACCURACY CIRCLE
                L.circle([lat, lng], {
                    radius: accuracy,
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.2
                }).addTo(map);

                // ROUTING
                const routingControl = L.Routing.control({
                    waypoints: [ L.latLng(lat, lng) ],
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        profile: 'driving'
                    }),
                    lineOptions: {
                        styles: [{ color: '#1e90ff', weight: 6, opacity: 0.9 }]
                    },
                    addWaypoints: false,
                    routeWhileDragging: false,
                    createMarker: () => null
                }).addTo(map);

                let destinationMarker = null;
                let searchMarker = null;

                // TAP DESTINATION
                map.on('click', function(e) {
                    const dest = e.latlng;

                    if (destinationMarker) map.removeLayer(destinationMarker);

                    destinationMarker = L.marker(dest, { icon: blueIcon })
                        .addTo(map)
                        .bindPopup("üîµ Destination")
                        .openPopup();

                    routingControl.setWaypoints([
                        L.latLng(lat, lng),
                        dest
                    ]);
                });

                // RECENTER
                document.getElementById("centerBtn").onclick = () => {
                    map.setView([lat, lng], 17);
                };

                // üîç SEARCH FUNCTION (NOMINATIM)
                document.getElementById("searchBtn").onclick = () => {
                    const query = document.getElementById("searchInput").value;
                    if (!query) return;

                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`)
                        .then(res => res.json())
                        .then(data => {
                            if (data.length === 0) {
                                alert("Place not found");
                                return;
                            }

                            const p = data[0];
                            const sLat = p.lat;
                            const sLng = p.lon;

                            if (searchMarker) map.removeLayer(searchMarker);

                            searchMarker = L.marker([sLat, sLng], { icon: blueIcon })
                                .addTo(map)
                                .bindPopup(p.display_name)
                                .openPopup();

                            map.setView([sLat, sLng], 17);
                        });
                };

            },
            err => alert("Location error: " + err.message),
            {
                enableHighAccuracy: true,
                timeout: 20000,
                maximumAge: 0
            }
        );

    });
</script>

</body>
</html>
